import unittest
from unittest.mock import MagicMock, patch
import sys
import os

# Add the project root to the python path
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '../../')))

from vectorai_app.core.exploit import AIExploitGenerator

class TestAIExploitGenerator(unittest.TestCase):
    def setUp(self):
        self.generator = AIExploitGenerator()
        self.cve_data = {
            "cve_id": "CVE-2023-1234",
            "description": "SQL injection in /login.php via username parameter allows remote attackers to execute arbitrary SQL commands.",
            "cvss_score": 9.8
        }
        self.target_info = {
            "target_ip": "192.168.1.10",
            "target_port": 80,
            "target_os": "Linux",
            "target_arch": "x64"
        }

    def test_analyze_vulnerability_details_sqli(self):
        """Test analysis of SQL injection vulnerability"""
        vuln_type, details = self.generator._analyze_vulnerability_details(
            self.cve_data["description"], self.cve_data
        )
        
        self.assertEqual(vuln_type, "sql_injection")
        # Check if endpoints list is not empty before accessing index 0
        if details.get("endpoints"):
            self.assertIn("login.php", details["endpoints"][0])
        self.assertIn("username", details["parameters"])

    def test_analyze_vulnerability_details_xss(self):
        """Test analysis of XSS vulnerability"""
        description = "Reflected Cross-Site Scripting (XSS) in /search.php via q parameter."
        vuln_type, details = self.generator._analyze_vulnerability_details(
            description, {"cve_id": "CVE-2023-5678"}
        )
        
        self.assertEqual(vuln_type, "xss")
        self.assertEqual(details["xss_type"], "reflected")

    def test_analyze_vulnerability_details_rce(self):
        """Test analysis of RCE vulnerability"""
        description = "Remote Code Execution (RCE) vulnerability in /upload.php allows attackers to execute arbitrary commands."
        vuln_type, details = self.generator._analyze_vulnerability_details(
            description, {"cve_id": "CVE-2023-9012"}
        )
        
        self.assertEqual(vuln_type, "rce")

    def test_generate_exploit_sqli(self):
        """Test generation of SQL injection exploit"""
        result = self.generator.generate_exploit_from_cve(self.cve_data, self.target_info)
        
        self.assertTrue(result["success"])
        exploit_code = result["exploit_code"]
        self.assertIn("SQL Injection Exploit", exploit_code)
        self.assertIn("CVE-2023-1234", exploit_code)
        self.assertIn("login.php", exploit_code)
        self.assertIn("username", exploit_code)

    def test_generate_exploit_generic(self):
        """Test generation of generic exploit when type is unknown"""
        cve_data = {
            "cve_id": "CVE-2023-0000",
            "description": "Some unknown vulnerability."
        }
        result = self.generator.generate_exploit_from_cve(cve_data, self.target_info)
        
        self.assertTrue(result["success"])
        exploit_code = result["exploit_code"]
        self.assertIn("Generic Exploit", exploit_code)
        self.assertIn("CVE-2023-0000", exploit_code)

    def test_generate_buffer_overflow_exploit(self):
        """Test generation of buffer overflow exploit"""
        cve_data = {
            "cve_id": "CVE-2023-BOF",
            "description": "Buffer overflow in server.exe via long packet."
        }
        
        result = self.generator.generate_exploit_from_cve(cve_data, self.target_info)
        
        self.assertTrue(result["success"])
        exploit_code = result["exploit_code"]
        self.assertIn("Buffer Overflow Exploit", exploit_code)
        self.assertIn("struct.pack", exploit_code)

if __name__ == '__main__':
    unittest.main()
